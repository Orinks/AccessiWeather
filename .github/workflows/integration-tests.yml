name: Integration Tests

# Run integration tests on a schedule to catch API changes
# and validate weather provider data quality without blocking PRs
on:
  # Run daily at 6 AM UTC (before most development hours)
  schedule:
    - cron: '0 6 * * *'

jobs:
  integration-tests:
    name: Weather Provider Integration Tests
    runs-on: ubuntu-latest

    # Only run on the scheduled trigger
    if: github.event_name == 'schedule'

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcairo2-dev \
            libgirepository1.0-dev \
            pkg-config \
            python3-dev

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Run integration tests
        id: run-tests
        uses: nick-fields/retry@v3
        continue-on-error: true
        with:
          max_attempts: 3
          retry_wait_seconds: 60
          timeout_minutes: 20
          shell: bash
          command: |
            set -euo pipefail
            pytest tests/integration/ \
              -v \
              --tb=short \
              --reruns 2 \
              --reruns-delay 10 \
              --junitxml=reports/integration-junit.xml
        env:
          RUN_INTEGRATION_TESTS: "1"

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-tests-${{ matrix.python-version }}
          path: reports/integration-junit.xml
          retention-days: 7

      - name: Add outcome summary
        if: always()
        run: |
          echo "## Integration test outcome" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.run-tests.outcome }}" = "success" ]; then
            echo "âœ… Integration suite passed after automated retries." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Integration suite failed after automated retries. This workflow won't block merges, but please review the logs and rerun manually if needed." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure (scheduled runs)
        if: steps.run-tests.outcome == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_title = `ðŸš¨ Integration Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const issue_body = `
            ## Integration Test Failure

            The scheduled integration tests have failed. This may indicate:

            - Changes to weather provider APIs (NWS or Open-Meteo)
            - Network/connectivity issues
            - Data quality problems
            - Parsing bugs

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            **Next Steps:**
            1. Review the test output in the workflow logs
            2. Check if NWS or Open-Meteo APIs have changed
            3. Verify network connectivity is working
            4. Run tests locally: \`RUN_INTEGRATION_TESTS=1 pytest tests/integration/ -v\`

            This issue will be closed automatically if the next scheduled run passes.
            `;

            // Check if there's already an open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'integration-test-failure',
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issue_title,
                body: issue_body,
                labels: ['integration-test-failure', 'bug', 'automation'],
              });
            }

      - name: Close failure issues on success (scheduled runs)
        if: steps.run-tests.outcome == 'success' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'integration-test-failure',
            });

            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… Integration tests are now passing. Closing this issue.',
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
              });
            }
