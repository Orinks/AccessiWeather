name: Integration Tests

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      update_cassettes:
        description: 'Update VCR cassettes'
        type: boolean
        default: false

jobs:
  integration:
    name: Weather Provider Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y gcc pkg-config python3-dev libgtk-3-dev libnotify-dev libsdl2-dev libwebkit2gtk-4.1-dev freeglut3-dev
          pip install -f https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-24.04 wxPython
          pip install -r requirements-dev.txt -e .

      - name: Run integration tests
        env:
          LIVE_WEATHER_TESTS: "1"
          VISUAL_CROSSING_API_KEY: ${{ secrets.VISUAL_CROSSING_API_KEY }}
        run: |
          pytest tests/integration/ -v --tb=short \
            --record-mode=${{ inputs.update_cassettes && 'all' || 'none' }}
        timeout-minutes: 15

      - name: Commit cassettes
        if: inputs.update_cassettes && success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet tests/integration/cassettes/ || \
            (git add tests/integration/cassettes/ && git commit -m "chore: update VCR cassettes" && git push)