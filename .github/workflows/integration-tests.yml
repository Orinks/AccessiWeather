name: Integration Tests

# Run integration tests on a schedule to catch API changes
# and validate weather provider data quality without blocking PRs
on:
  # Run daily at 6 AM UTC (before most development hours)
  schedule:
    - cron: '0 6 * * *'

  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      update_cassettes:
        description: 'Update VCR cassettes (rewrite with fresh API data)'
        required: false
        default: false
        type: boolean

jobs:
  integration-tests:
    name: Weather Provider Integration Tests
    runs-on: ubuntu-latest

    # Only run on schedule or manual dispatch
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.13']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcairo2-dev \
            libgirepository-2.0-dev \
            pkg-config \
            python3-dev

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Run integration tests (replay mode)
        if: ${{ github.event.inputs.update_cassettes != 'true' }}
        run: |
          pytest tests/integration/ \
            -v \
            --tb=short \
            --record-mode=none
        env:
          LIVE_WEATHER_TESTS: "1"
          VISUAL_CROSSING_API_KEY: ${{ secrets.VISUAL_CROSSING_API_KEY }}
        timeout-minutes: 15

      - name: Run integration tests (update cassettes)
        if: ${{ github.event.inputs.update_cassettes == 'true' }}
        run: |
          pytest tests/integration/ \
            -v \
            --tb=short \
            --record-mode=all
        env:
          LIVE_WEATHER_TESTS: "1"
          VISUAL_CROSSING_API_KEY: ${{ secrets.VISUAL_CROSSING_API_KEY }}
        timeout-minutes: 15

      - name: Commit and push new cassettes (if any)
        if: ${{ success() && github.event.inputs.update_cassettes == 'true' }}
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are any changes to cassettes
          if git diff --quiet tests/integration/cassettes/; then
            echo "No cassette changes to commit"
          else
            echo "Committing new/updated cassettes..."
            git add tests/integration/cassettes/
            git commit -m $'chore: update VCR cassettes from integration tests run\n\nThis commit updates HTTP cassettes recorded from live weather API calls.\nRun: '"$RUN_URL"
            git push origin main
          fi

      - name: Notify on failure (scheduled runs)
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          script: |
            const issue_title = `ðŸš¨ Integration Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const issue_body = `
            ## Integration Test Failure

            The scheduled integration tests have failed. This may indicate:

            - Changes to weather provider APIs (NWS or Open-Meteo)
            - Network/connectivity issues
            - Data quality problems
            - Parsing bugs

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            **Next Steps:**
            1. Review the test output in the workflow logs
            2. Check if NWS or Open-Meteo APIs have changed
            3. Verify network connectivity is working
            4. Run tests locally: \`LIVE_WEATHER_TESTS=1 pytest tests/integration/ -v\`

            This issue will be closed automatically if the next scheduled run passes.
            `;

            // Check if there's already an open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'integration-test-failure',
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issue_title,
                body: issue_body,
                labels: ['integration-test-failure', 'bug', 'automation'],
              });
            }

      - name: Close failure issues on success (scheduled runs)
        if: success() && github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'integration-test-failure',
            });

            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… Integration tests are now passing. Closing this issue.',
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
              });
            }
