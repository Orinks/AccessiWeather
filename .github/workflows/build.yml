name: Build and Package

on:
  push:
    branches: [ dev ]  # Only build on dev branch pushes
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (optional)'
        required: false
        type: string
      skip_cache:
        description: 'Skip build cache'
        required: false
        type: boolean
        default: false
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed
    branches: [ dev ]  # Only trigger after CI on dev branch

permissions:
  contents: read      # Read repository contents
  actions: write      # Trigger repository dispatch events
  packages: read      # Read packages (for caching)

env:
  # Build configuration
  PYTHON_VERSION: "3.12"
  PYINSTALLER_CACHE_DIR: "~/.cache/pyinstaller"

jobs:
  build:
    name: Build Windows Application
    runs-on: windows-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || github.event_name == 'push' }}

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for build metadata

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-build-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-build-pip-

    - name: Cache PyInstaller build cache
      uses: actions/cache@v3
      if: ${{ !github.event.inputs.skip_cache }}
      with:
        path: |
          ${{ env.PYINSTALLER_CACHE_DIR }}
          build/
          *.toc
        key: ${{ runner.os }}-pyinstaller-${{ hashFiles('src/**/*.py', 'AccessiWeather.spec') }}
        restore-keys: |
          ${{ runner.os }}-pyinstaller-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]
        pip install PyInstaller

    - name: Extract version
      id: version
      run: |
        if [ -n "${{ github.event.inputs.version_override }}" ]; then
          VERSION="${{ github.event.inputs.version_override }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
        else
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
      shell: bash

    - name: Update version files
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Update version.py with current version
        sed -i "s/__version__ = \"[^\"]*\"/__version__ = \"$VERSION\"/" src/accessiweather/version.py

        echo "Updated version to: $VERSION"
      shell: bash

    - name: Build with installer script
      run: |
        # The script handles PyInstaller, portable ZIP, and verification
        powershell -ExecutionPolicy Bypass -File installer/build_installer.ps1

    - name: Generate checksums
      run: |
        $VERSION = "${{ steps.version.outputs.version }}"

        # Generate checksums for artifacts
        $ExePath = "dist/AccessiWeather/AccessiWeather.exe"
        $ZipPath = "dist/AccessiWeather_Portable_v$VERSION.zip"

        if (Test-Path $ExePath) {
          $ExeHash = (Get-FileHash $ExePath -Algorithm SHA256).Hash
          Write-Host "Executable SHA256: $($ExeHash.Substring(0,16))..."
        }

        if (Test-Path $ZipPath) {
          $ZipHash = (Get-FileHash $ZipPath -Algorithm SHA256).Hash
          Write-Host "Portable ZIP SHA256: $($ZipHash.Substring(0,16))..."
        }

        # Create simple checksums file
        $ChecksumsContent = "AccessiWeather v$VERSION - Build Checksums`n`n$ExeHash  AccessiWeather.exe`n$ZipHash  AccessiWeather_Portable_v$VERSION.zip"
        $ChecksumsContent | Out-File -FilePath "dist/checksums.txt" -Encoding UTF8
        Write-Host "Checksums saved to checksums.txt"

    - name: Upload portable build artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable-${{ steps.version.outputs.version }}
        path: |
          dist/AccessiWeather_Portable_v${{ steps.version.outputs.version }}.zip
          dist/checksums.txt
        retention-days: 30

    - name: Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer-${{ steps.version.outputs.version }}
        path: |
          installer/dist/AccessiWeather_Setup_v${{ steps.version.outputs.version }}.exe
        retention-days: 90

    - name: Update GitHub Pages
      if: success()
      run: |
        # Trigger the existing update-pages workflow using workflow_dispatch
        $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/actions/workflows/update-pages.yml/dispatches" `
          -Method POST `
          -Headers @{
            "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
            "Accept" = "application/vnd.github.v3+json"
            "Content-Type" = "application/json"
          } `
          -Body (@{
            "ref" = "dev"
            "inputs" = @{
              "force_update" = "true"
              "target_branch" = "dev"
            }
          } | ConvertTo-Json -Depth 3)

        Write-Host "✓ Triggered GitHub Pages update workflow"

  validate:
    name: Validate Build
    runs-on: windows-latest
    needs: build

    steps:
    - name: Download installer artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-installer-${{ needs.build.outputs.version }}
        path: artifacts/installer/

    - name: Download portable artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-portable-${{ needs.build.outputs.version }}
        path: artifacts/portable/

    - name: Validate build artifacts
      run: |
        $VERSION = "${{ needs.build.outputs.version }}"

        Write-Host "=== Build Validation ==="
        Write-Host "Version: $VERSION"

        # Check installer artifacts
        $InstallerFile = "artifacts/installer/AccessiWeather_Setup_v$VERSION.exe"
        $InstallerChecksums = "artifacts/installer/checksums.txt"

        # Check portable artifacts
        $PortableFile = "artifacts/portable/AccessiWeather_Portable_v$VERSION.zip"
        $PortableChecksums = "artifacts/portable/checksums.txt"

        $AllFilesPresent = $true

        Write-Host "Checking installer artifacts:"
        if (Test-Path $InstallerFile) {
          $FileSize = (Get-Item $InstallerFile).Length
          $FileSizeMB = [math]::Round($FileSize / 1MB, 2)
          Write-Host "✓ AccessiWeather_Setup_v$VERSION.exe ($FileSizeMB MB)"
        } else {
          Write-Host "✗ Missing: AccessiWeather_Setup_v$VERSION.exe"
          $AllFilesPresent = $false
        }

        Write-Host "Checking portable artifacts:"
        if (Test-Path $PortableFile) {
          $FileSize = (Get-Item $PortableFile).Length
          $FileSizeMB = [math]::Round($FileSize / 1MB, 2)
          Write-Host "✓ AccessiWeather_Portable_v$VERSION.zip ($FileSizeMB MB)"
        } else {
          Write-Host "✗ Missing: AccessiWeather_Portable_v$VERSION.zip"
          $AllFilesPresent = $false
        }

        if ($AllFilesPresent) {
          Write-Host "✅ Build validation successful - separate artifacts created"
        } else {
          Write-Host "❌ Build validation failed"
          exit 1
        }
