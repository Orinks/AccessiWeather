name: Build

on:
  schedule:
    - cron: "30 3 * * *"  # Nightly at 3:30 UTC
  push:
    tags: ['v*.*.*']
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Skip release creation'
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}
      is_nightly: ${{ steps.check.outputs.is_nightly }}
      tag: ${{ steps.check.outputs.tag }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.ref_name == 'main' && github.ref || 'dev' }}
          fetch-depth: 0

      - name: Check build conditions
        id: check
        run: |
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            # Tagged release
            echo "is_nightly=false" >> $GITHUB_OUTPUT
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          else
            # Nightly build - check for changes
            echo "is_nightly=true" >> $GITHUB_OUTPUT
            echo "tag=nightly-$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            
            LAST_TAG=$(git tag --list "nightly-*" --sort=-version:refname | head -1)
            if [ -z "$LAST_TAG" ] || ! git diff --quiet "$LAST_TAG"..HEAD -- src/ pyproject.toml installer/; then
              echo "should_build=true" >> $GITHUB_OUTPUT
            else
              echo "should_build=false" >> $GITHUB_OUTPUT
            fi
          fi

  build-windows:
    name: Windows
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.is_nightly == 'true' && 'dev' || github.ref }}
          fetch-depth: 0

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install -e .[dev] pyinstaller pillow

      - name: Build
        run: |
          python scripts/generate_version.py
          python scripts/generate_build_info.py ${{ needs.prepare.outputs.is_nightly == 'true' && needs.prepare.outputs.tag || '' }}
          python installer/create_icons.py
          python -m PyInstaller --clean --noconfirm installer/accessiweather.spec

      - name: Create installer
        shell: cmd
        run: |
          echo [version]> dist\version.txt
          echo value=${{ needs.prepare.outputs.version }}>> dist\version.txt
          choco install innosetup -y --no-progress
          "%ProgramFiles(x86)%\Inno Setup 6\ISCC.exe" installer\accessiweather.iss

      - name: Create portable ZIP
        shell: cmd
        run: |
          cd dist
          7z a -tzip "AccessiWeather_Portable_v${{ needs.prepare.outputs.version }}.zip" "AccessiWeather_dir\*" || 7z a -tzip "AccessiWeather_Portable_v${{ needs.prepare.outputs.version }}.zip" "AccessiWeather.exe"

      - uses: actions/upload-artifact@v6
        with:
          name: windows
          path: |
            dist/AccessiWeather_Setup_*.exe
            dist/AccessiWeather_Portable_*.zip

  build-macos:
    name: macOS
    needs: prepare
    if: needs.prepare.outputs.should_build == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.is_nightly == 'true' && 'dev' || github.ref }}
          fetch-depth: 0

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install -e .[dev] pyinstaller pillow
          brew install create-dmg || true

      - name: Build
        run: |
          python scripts/generate_version.py
          python scripts/generate_build_info.py ${{ needs.prepare.outputs.is_nightly == 'true' && needs.prepare.outputs.tag || '' }}
          python installer/create_icons.py
          python -m PyInstaller --clean --noconfirm installer/accessiweather.spec

      - name: Create DMG
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          create-dmg --volname "AccessiWeather" --icon-size 100 \
            --icon "AccessiWeather.app" 175 190 --app-drop-link 425 190 \
            "dist/AccessiWeather_v${VERSION}.dmg" "dist/AccessiWeather.app" || \
          hdiutil create -volname "AccessiWeather" -srcfolder "dist/AccessiWeather.app" -ov -format UDZO "dist/AccessiWeather_v${VERSION}.dmg"

      - uses: actions/upload-artifact@v6
        with:
          name: macos
          path: dist/AccessiWeather_*.dmg

  release:
    name: Release
    needs: [prepare, build-windows, build-macos]
    if: always() && needs.prepare.outputs.should_build == 'true' && (needs.build-windows.result == 'success' || needs.build-macos.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.is_nightly == 'true' && 'dev' || github.ref }}
          fetch-depth: 0

      - uses: actions/download-artifact@v7
        with:
          path: dist
          merge-multiple: true
        continue-on-error: true

      - name: Prepare release
        id: prep
        env:
          IS_NIGHTLY: ${{ needs.prepare.outputs.is_nightly }}
          VERSION: ${{ needs.prepare.outputs.version }}
          TAG: ${{ needs.prepare.outputs.tag }}
        run: |
          mkdir -p assets
          TIMESTAMP=$(date -u +%Y%m%d)
          
          # Rename assets based on release type
          for f in dist/*.exe dist/*.dmg dist/*.zip; do
            [ -f "$f" ] || continue
            name=$(basename "$f")
            if [ "$IS_NIGHTLY" = "true" ]; then
              case "$name" in
                *Setup*.exe) mv "$f" "assets/AccessiWeather-nightly-${TIMESTAMP}-windows-setup.exe" ;;
                *Portable*.zip) mv "$f" "assets/AccessiWeather-nightly-${TIMESTAMP}-windows-portable.zip" ;;
                *.dmg) mv "$f" "assets/AccessiWeather-nightly-${TIMESTAMP}-macOS.dmg" ;;
              esac
            else
              case "$name" in
                *Setup*.exe) mv "$f" "assets/AccessiWeather-${VERSION}-windows-setup.exe" ;;
                *Portable*.zip) mv "$f" "assets/AccessiWeather-${VERSION}-windows-portable.zip" ;;
                *.dmg) mv "$f" "assets/AccessiWeather-${VERSION}-macOS.dmg" ;;
              esac
            fi
          done
          
          # Generate checksums
          cd assets && sha256sum * > checksums.txt 2>/dev/null || true
          
          # Generate release notes
          cd ..
          if [ "$IS_NIGHTLY" = "true" ]; then
            LAST_TAG=$(git tag --list "nightly-*" --sort=-version:refname | head -1)
            if [ -n "$LAST_TAG" ]; then
              git log "$LAST_TAG"..HEAD --oneline --no-merges | sed 's/^/- /' > notes.md
            else
              echo "Initial nightly build" > notes.md
            fi
          else
            # Extract from CHANGELOG.md
            python3 -c "
          import re
          with open('CHANGELOG.md') as f:
              content = f.read()
          match = re.search(r'## \[${VERSION}\].*?\n(.*?)(?=## \[|$)', content, re.DOTALL)
          print(match.group(1).strip() if match else 'See CHANGELOG.md')
          " > notes.md
          fi

      - name: Create release
        if: ${{ inputs.dry_run != true }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IS_NIGHTLY: ${{ needs.prepare.outputs.is_nightly }}
          TAG: ${{ needs.prepare.outputs.tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          gh release delete "$TAG" -y --cleanup-tag 2>/dev/null || true
          
          OPTS="--title"
          if [ "$IS_NIGHTLY" = "true" ]; then
            OPTS="$OPTS \"Nightly $(date -u +%Y-%m-%d)\" --prerelease --target dev"
          else
            OPTS="$OPTS \"AccessiWeather v${VERSION}\""
          fi
          
          gh release create "$TAG" assets/* --notes-file notes.md $OPTS

      - name: Trigger pages update
        if: ${{ inputs.dry_run != true }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run update-pages.yml || true
