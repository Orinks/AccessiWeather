name: Nightly Dev Prerelease

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: write

concurrency:
  group: nightly-release
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  FORCE_COLOR: "0"
  PYTHONUTF8: "1"
  PYTHON_VERSION: "3.12"

jobs:
  prepare:
    name: Check for changes
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changes.outputs.changed }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Check for changes in src/ since last nightly
        id: changes
        run: |
          git fetch --tags

          # Get HEAD commit SHA
          HEAD_SHA=$(git rev-parse HEAD)
          echo "HEAD commit: $HEAD_SHA"

          # Check if HEAD already has a nightly tag (already released)
          HEAD_TAGS=$(git tag --points-at HEAD | grep "^nightly-" || true)
          if [ -n "$HEAD_TAGS" ]; then
            echo "HEAD already has nightly tag(s): $HEAD_TAGS"
            echo "Skipping build - this commit was already released."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find the latest nightly tag
          LAST_NIGHTLY_TAG=$(git tag --list "nightly-*" --sort=-version:refname | head -n 1)
          echo "Last nightly tag: $LAST_NIGHTLY_TAG"

          if [ -z "$LAST_NIGHTLY_TAG" ]; then
            echo "No previous nightly tag found - first nightly build."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get the commit SHA of the last nightly tag
          LAST_NIGHTLY_SHA=$(git rev-parse "$LAST_NIGHTLY_TAG^{commit}")
          echo "Last nightly commit: $LAST_NIGHTLY_SHA"

          # Check if there are ANY commits since last nightly (not just src/ changes)
          COMMIT_COUNT=$(git rev-list --count "$LAST_NIGHTLY_TAG"..HEAD)
          echo "Commits since last nightly: $COMMIT_COUNT"

          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "No new commits since last nightly."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check for meaningful changes in src/ or pyproject.toml
          if git diff --quiet "$LAST_NIGHTLY_TAG"..HEAD -- src/ pyproject.toml installer/; then
            echo "No changes in src/, pyproject.toml, or installer/ since last nightly."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected in src/, pyproject.toml, or installer/ since last nightly."
            git --no-pager diff --stat "$LAST_NIGHTLY_TAG"..HEAD -- src/ pyproject.toml installer/ | tail -20
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Get version
        id: version
        run: |
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: prepare
    if: needs.prepare.outputs.changed == 'true'
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-nightly-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-nightly-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[dev]
          pip install pyinstaller pillow

      - name: Get version
        id: version
        run: |
          # Just use the version from pyproject.toml
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Generate icons
        run: python installer/create_icons.py

      - name: Build with PyInstaller
        run: python -m PyInstaller --clean --noconfirm installer/accessiweather.spec

      - name: Install Inno Setup
        run: choco install innosetup -y --no-progress

      - name: Create Windows Installer
        run: |
          # Pass version from pyproject.toml to Inno Setup
          # Script file must come BEFORE /D parameters
          "/c/Program Files (x86)/Inno Setup 6/ISCC.exe" installer/accessiweather.iss /DMyAppVersion=${{ steps.version.outputs.version }}

      - name: Create portable ZIP
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd dist
          if [ -d "AccessiWeather_dir" ]; then
            7z a -tzip "AccessiWeather_Portable_v${VERSION}.zip" "AccessiWeather_dir/*"
          elif [ -f "AccessiWeather.exe" ]; then
            7z a -tzip "AccessiWeather_Portable_v${VERSION}.zip" "AccessiWeather.exe"
          fi

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: nightly-windows-installer
          path: dist/AccessiWeather_Setup_*.exe
          retention-days: 7

      - name: Upload Windows Portable
        uses: actions/upload-artifact@v4
        with:
          name: nightly-windows-portable
          path: dist/AccessiWeather_Portable_*.zip
          retention-days: 7

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: prepare
    if: needs.prepare.outputs.changed == 'true'
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-nightly-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-nightly-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[dev]
          pip install pyinstaller pillow
          brew install create-dmg || true

      - name: Get version
        id: version
        run: |
          # Just use the version from pyproject.toml
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Generate icons
        run: python installer/create_icons.py

      - name: Build with PyInstaller
        run: python -m PyInstaller --clean --noconfirm installer/accessiweather.spec

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Try create-dmg first, fallback to hdiutil
          if command -v create-dmg &> /dev/null; then
            create-dmg \
              --volname "AccessiWeather" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "AccessiWeather.app" 175 190 \
              --hide-extension "AccessiWeather.app" \
              --app-drop-link 425 190 \
              "dist/AccessiWeather_v${VERSION}.dmg" \
              "dist/AccessiWeather.app" || \
              hdiutil create -volname "AccessiWeather" -srcfolder "dist/AccessiWeather.app" -ov -format UDZO "dist/AccessiWeather_v${VERSION}.dmg"
          else
            hdiutil create -volname "AccessiWeather" -srcfolder "dist/AccessiWeather.app" -ov -format UDZO "dist/AccessiWeather_v${VERSION}.dmg"
          fi

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: nightly-macos-dmg
          path: dist/AccessiWeather_*.dmg
          retention-days: 7

  nightly-release:
    name: Publish Nightly Release
    needs: [prepare, build-windows, build-macos]
    if: needs.prepare.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: nightly-*
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -laR dist/

      - name: Prepare assets
        run: |
          TIMESTAMP=$(date -u +%Y%m%d)
          cd dist

          # Flatten directory structure - extract files from subdirectories
          find . -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.zip" \) -exec mv {} . \;

          # Remove empty directories
          find . -type d -empty -delete

          # Remove existing checksums if they exist
          rm -f checksums.txt

          # Rename artifacts to nightly format
          for file in *; do
            # Skip if it's not a file
            [ -f "$file" ] || continue

            if [[ "$file" == AccessiWeather_Setup_*.exe ]]; then
              mv "$file" "AccessiWeather-nightly-${TIMESTAMP}-windows-setup.exe"
            elif [[ "$file" == *.dmg ]]; then
              mv "$file" "AccessiWeather-nightly-${TIMESTAMP}-macOS.dmg"
            elif [[ "$file" == AccessiWeather_Portable_*.zip ]]; then
              mv "$file" "AccessiWeather-nightly-${TIMESTAMP}-windows-portable.zip"
            fi
          done

          # Generate new checksums
          sha256sum *.exe *.dmg *.zip 2>/dev/null > checksums.txt || true

          echo "Prepared assets:"
          ls -la

      - name: Create Prerelease
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="nightly-$(date -u +%Y%m%d)"
          TITLE="Nightly $(date -u +%Y-%m-%d)"

          # Delete existing release/tag if re-running for the same day
          gh release delete "$TAG" -y --cleanup-tag || true

          # Upload files from dist/
          cd dist
          gh release create "$TAG" *.exe *.dmg *.zip checksums.txt \
            --title "$TITLE" \
            --generate-notes \
            --prerelease \
            --target dev

  trigger-pages-update:
    name: Trigger Pages Update
    needs: [prepare, nightly-release]
    if: needs.prepare.outputs.changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger update-pages workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run update-pages.yml \
            --repo ${{ github.repository }} \
            -f force_update=true \
            -f target_branch=both
