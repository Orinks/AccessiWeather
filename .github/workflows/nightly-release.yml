name: Nightly Dev Prerelease

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: write

concurrency:
  group: nightly-release
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  FORCE_COLOR: "0"
  PYTHONUTF8: "1"
  PYTHON_VERSION: "3.12"

jobs:
  prepare:
    name: Check for changes
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changes.outputs.changed }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: dev
          fetch-depth: 0

      - name: Check for changes in src/ since last nightly
        id: changes
        run: |
          git fetch --tags

          # Get HEAD commit SHA
          HEAD_SHA=$(git rev-parse HEAD)
          echo "HEAD commit: $HEAD_SHA"

          # Check if HEAD already has a nightly tag (already released)
          HEAD_TAGS=$(git tag --points-at HEAD | grep "^nightly-" || true)
          if [ -n "$HEAD_TAGS" ]; then
            echo "HEAD already has nightly tag(s): $HEAD_TAGS"
            echo "Skipping build - this commit was already released."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find the latest nightly tag
          LAST_NIGHTLY_TAG=$(git tag --list "nightly-*" --sort=-version:refname | head -n 1)
          echo "Last nightly tag: $LAST_NIGHTLY_TAG"

          if [ -z "$LAST_NIGHTLY_TAG" ]; then
            echo "No previous nightly tag found - first nightly build."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get the commit SHA of the last nightly tag
          LAST_NIGHTLY_SHA=$(git rev-parse "$LAST_NIGHTLY_TAG^{commit}")
          echo "Last nightly commit: $LAST_NIGHTLY_SHA"

          # Check if there are ANY commits since last nightly (not just src/ changes)
          COMMIT_COUNT=$(git rev-list --count "$LAST_NIGHTLY_TAG"..HEAD)
          echo "Commits since last nightly: $COMMIT_COUNT"

          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "No new commits since last nightly."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check for meaningful changes in src/ directory
          if git diff --quiet "$LAST_NIGHTLY_TAG"..HEAD -- src/; then
            echo "No changes in src/ since last nightly."
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected in src/ since last nightly."
            git --no-pager diff --stat "$LAST_NIGHTLY_TAG"..HEAD -- src/ | tail -20
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Get version
        id: version
        run: |
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: prepare
    if: needs.prepare.outputs.changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            installer_pattern: "*.msi"
          - os: macos-latest
            platform: macOS
            installer_pattern: "*.dmg"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .[dev]
          pip install briefcase

      - name: Create Briefcase app scaffold
        run: python installer/make.py create --platform ${{ matrix.platform }}
        env:
          DISPLAY: ""
          ACCESSIWEATHER_TEST_MODE: "1"

      - name: Build Briefcase app
        run: python installer/make.py build --platform ${{ matrix.platform }}
        env:
          DISPLAY: ""
          ACCESSIWEATHER_TEST_MODE: "1"

      - name: Create portable ZIP (Windows only)
        if: matrix.platform == 'windows'
        run: python installer/make.py zip --platform windows || true
        env:
          DISPLAY: ""
          ACCESSIWEATHER_TEST_MODE: "1"

      - name: Package Briefcase app
        run: python installer/make.py package --platform ${{ matrix.platform }}
        env:
          DISPLAY: ""
          ACCESSIWEATHER_TEST_MODE: "1"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v5
        with:
          name: nightly-${{ matrix.platform }}-installer
          path: dist/${{ matrix.installer_pattern }}
          retention-days: 7

      - name: Upload portable artifact (Windows only)
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v5
        with:
          name: nightly-windows-portable
          path: dist/AccessiWeather_Portable_v${{ needs.prepare.outputs.version }}.zip
          retention-days: 7

  nightly-release:
    name: Publish Nightly Release
    needs: [prepare, build]
    if: needs.prepare.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: dist
          pattern: nightly-*
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -laR dist/

      - name: Prepare assets
        run: |
          TIMESTAMP=$(date -u +%Y%m%d)
          cd dist

          # Flatten directory structure - extract files from subdirectories
          find . -type f \( -name "*.msi" -o -name "*.dmg" -o -name "*.zip" \) -exec mv {} . \;

          # Remove empty directories
          find . -type d -empty -delete

          # Remove existing checksums if they exist
          rm -f checksums.txt

          # Rename artifacts
          for file in *; do
            # Skip if it's not a file
            [ -f "$file" ] || continue

            if [[ "$file" == *.msi ]]; then
              mv "$file" "AccessiWeather-nightly-${TIMESTAMP}-windows-setup.msi"
            elif [[ "$file" == *.dmg ]]; then
              mv "$file" "AccessiWeather-nightly-${TIMESTAMP}-macOS.dmg"
            elif [[ "$file" == *.zip ]]; then
              mv "$file" "AccessiWeather-nightly-${TIMESTAMP}-windows-portable.zip"
            fi
          done

          # Generate new checksums (only for files, not directories)
          sha256sum *.msi *.dmg *.zip 2>/dev/null > checksums.txt || true

          echo "Prepared assets:"
          ls -la

      - name: Create Prerelease
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="nightly-$(date -u +%Y%m%d)"
          TITLE="Nightly $(date -u +%Y-%m-%d)"

          # Delete existing release/tag if re-running for the same day
          gh release delete "$TAG" -y --cleanup-tag || true

          # Only upload files from dist/ (exclude subdirectories)
          cd dist
          gh release create "$TAG" *.msi *.dmg *.zip checksums.txt \
            --title "$TITLE" \
            --generate-notes \
            --prerelease \
            --target dev

  trigger-pages-update:
    name: Trigger Pages Update
    needs: [prepare, nightly-release]
    if: needs.prepare.outputs.changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger update-pages workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run update-pages.yml \
            --repo ${{ github.repository }} \
            -f force_update=true \
            -f target_branch=dev
