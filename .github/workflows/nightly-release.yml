name: Nightly Dev Prerelease

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: nightly-release
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  FORCE_COLOR: "1"

jobs:
  prepare:
    name: Check for changes & find artifacts
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.changes.outputs.changed }}
      run_id: ${{ steps.find_run.outputs.run_id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check for changes in src/ since last nightly
        id: changes
        run: |
          git fetch --tags
          LAST_NIGHTLY_TAG=$(git tag --list "nightly-*" --sort=-committerdate | head -n 1)
          echo "Last nightly tag: $LAST_NIGHTLY_TAG"

          if [ -z "$LAST_NIGHTLY_TAG" ]; then
            echo "No previous nightly tag found."
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if git diff --quiet "$LAST_NIGHTLY_TAG"..HEAD -- src; then
               echo "No changes in src/."
               echo "changed=false" >> "$GITHUB_OUTPUT"
            else
               echo "Changes detected in src/."
               echo "changed=true" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Find latest successful build
        if: steps.changes.outputs.changed == 'true'
        id: find_run
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "Looking for successful builds on branch: $BRANCH_NAME"
          # Find the latest successful run of 'briefcase-build.yml' on the current branch
          RUN_ID=$(gh api "repos/${{ github.repository }}/actions/workflows/briefcase-build.yml/runs?branch=$BRANCH_NAME&status=success&per_page=1" \
            --jq '.workflow_runs[0].id')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
            echo "No successful build found on $BRANCH_NAME."
            exit 1
          fi

          echo "Found run ID: $RUN_ID"
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

  nightly-release:
    name: Publish Nightly Release
    needs: prepare
    if: needs.prepare.outputs.changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts via gh cli
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist
          RUN_ID=${{ needs.prepare.outputs.run_id }}
          echo "Downloading artifacts from run $RUN_ID"
          gh run download $RUN_ID --dir dist

          # gh run download creates subdirectories for each artifact. Flatten them.
          # We only care about installers and portables
          find dist -type f -name "*installer*" -exec mv {} dist/ \;
          find dist -type f -name "*portable*" -exec mv {} dist/ \;

          # Clean up empty directories (and any artifacts we didn't move)
          find dist -type d -empty -delete

          # List contents for verification
          ls -R dist

      - name: Prepare assets
        run: |
          TIMESTAMP=$(date -u +%Y%m%d)
          cd dist

          # Remove existing checksums if they exist
          rm -f checksums.txt

          # Rename artifacts
          for file in *; do
            # Skip if it's not a file we care about (though dist should only contain our downloads)
            [ -f "$file" ] || continue

            if [[ "$file" == *.msi ]]; then
              mv "$file" "AccessiWeather-nightly-${TIMESTAMP}-windows-setup.msi"
            elif [[ "$file" == *.dmg ]]; then
              mv "$file" "AccessiWeather-nightly-${TIMESTAMP}-macOS.dmg"
            elif [[ "$file" == *.zip ]]; then
              mv "$file" "AccessiWeather-nightly-${TIMESTAMP}-windows-portable.zip"
            fi
          done

          # Generate new checksums
          sha256sum * > checksums.txt

          echo "Prepared assets:"
          ls -la

      - name: Create Prerelease
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="nightly-$(date -u +%Y%m%d)"
          TITLE="Nightly $(date -u +%Y-%m-%d)"

          # Delete existing release/tag if re-running for the same day
          gh release delete "$TAG" -y --cleanup-tag || true

          gh release create "$TAG" dist/* \
            --title "$TITLE" \
            --generate-notes \
            --prerelease
