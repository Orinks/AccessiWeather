name: Nightly Dev Prerelease

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force build even if no changes'
        type: boolean
        default: false

permissions:
  contents: write
  actions: write

concurrency:
  group: nightly-release
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: dev
          fetch-depth: 0

      - name: Check for changes
        id: check
        run: |
          if [ "${{ inputs.force_build }}" == "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if HEAD already has a nightly tag
          if git tag --points-at HEAD | grep -q "^nightly-"; then
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          LAST_TAG=$(git tag -l "nightly-*" --sort=-version:refname | head -1)
          if [ -z "$LAST_TAG" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if git diff --quiet "$LAST_TAG"..HEAD -- src/ pyproject.toml installer/; then
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

      - name: Get version
        id: version
        run: |
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build-windows:
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: dev

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build
        shell: bash
        run: |
          pip install -e .[dev] pyinstaller pillow
          python scripts/generate_version.py
          python scripts/generate_build_info.py "nightly-$(date -u +%Y%m%d)"
          python installer/create_icons.py
          python -m PyInstaller --clean --noconfirm installer/accessiweather.spec
          
          # Create installer
          choco install innosetup -y --no-progress
          echo "[version]" > dist/version.txt
          echo "value=${{ needs.check-changes.outputs.version }}" >> dist/version.txt
          "/c/Program Files (x86)/Inno Setup 6/ISCC.exe" installer/accessiweather.iss
          
          # Create portable
          cd dist
          7z a -tzip "AccessiWeather_Portable_v${{ needs.check-changes.outputs.version }}.zip" "AccessiWeather_dir/*" || \
          7z a -tzip "AccessiWeather_Portable_v${{ needs.check-changes.outputs.version }}.zip" "AccessiWeather.exe"

      - uses: actions/upload-artifact@v6
        with:
          name: windows-build
          path: |
            dist/AccessiWeather_Setup_*.exe
            dist/AccessiWeather_Portable_*.zip
          retention-days: 7

  build-macos:
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: dev

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build
        run: |
          pip install -e .[dev] pyinstaller pillow
          brew install create-dmg || true
          
          python scripts/generate_version.py
          python scripts/generate_build_info.py "nightly-$(date -u +%Y%m%d)"
          python installer/create_icons.py
          python -m PyInstaller --clean --noconfirm installer/accessiweather.spec
          
          VERSION="${{ needs.check-changes.outputs.version }}"
          create-dmg --volname "AccessiWeather" --icon "AccessiWeather.app" 175 190 \
            --app-drop-link 425 190 "dist/AccessiWeather_v${VERSION}.dmg" "dist/AccessiWeather.app" || \
          hdiutil create -volname "AccessiWeather" -srcfolder "dist/AccessiWeather.app" -ov -format UDZO "dist/AccessiWeather_v${VERSION}.dmg"

      - uses: actions/upload-artifact@v6
        with:
          name: macos-build
          path: dist/AccessiWeather_*.dmg
          retention-days: 7

  release:
    needs: [check-changes, build-windows, build-macos]
    if: always() && needs.check-changes.outputs.should_build == 'true' && (needs.build-windows.result == 'success' || needs.build-macos.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: dev
          fetch-depth: 0

      - uses: actions/download-artifact@v7
        with:
          path: dist
          merge-multiple: true
        continue-on-error: true

      - name: Prepare release
        run: |
          cd dist
          TAG="nightly-$(date -u +%Y%m%d)"
          
          # Rename to nightly format
          for f in AccessiWeather_Setup_*.exe; do [ -f "$f" ] && mv "$f" "AccessiWeather-${TAG}-windows-setup.exe"; done
          for f in AccessiWeather_Portable_*.zip; do [ -f "$f" ] && mv "$f" "AccessiWeather-${TAG}-windows-portable.zip"; done
          for f in AccessiWeather_*.dmg; do [ -f "$f" ] && mv "$f" "AccessiWeather-${TAG}-macOS.dmg"; done
          
          sha256sum *.exe *.dmg *.zip 2>/dev/null > checksums.txt || true

      - name: Install git-cliff
        run: |
          CLIFF_VERSION=$(curl -sI https://github.com/orhun/git-cliff/releases/latest | grep -i location | sed 's/.*tag\/v//' | tr -d '\r\n')
          curl -sSfL "https://github.com/orhun/git-cliff/releases/download/v${CLIFF_VERSION}/git-cliff-${CLIFF_VERSION}-x86_64-unknown-linux-gnu.tar.gz" | tar xz
          sudo mv "git-cliff-${CLIFF_VERSION}/git-cliff" /usr/local/bin/

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="nightly-$(date -u +%Y%m%d)"
          LAST_TAG=$(git tag -l "nightly-*" --sort=-version:refname | head -1)
          
          # Generate changelog
          if [ -n "$LAST_TAG" ]; then
            git-cliff "$LAST_TAG"..HEAD --unreleased > notes.md 2>/dev/null || \
            git log "$LAST_TAG"..HEAD --oneline --no-merges -20 | sed 's/^/- /' > notes.md
          else
            git-cliff --unreleased -l 20 > notes.md 2>/dev/null || echo "Initial nightly build" > notes.md
          fi
          
          gh release delete "$TAG" -y --cleanup-tag 2>/dev/null || true
          gh release create "$TAG" dist/*.exe dist/*.dmg dist/*.zip dist/checksums.txt \
            --title "Nightly $(date -u +%Y-%m-%d)" \
            --notes-file notes.md \
            --prerelease \
            --target dev

      - name: Trigger pages update
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run update-pages.yml
