name: Build and Package with Briefcase

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (optional)'
        required: false
        type: string
      skip_cache:
        description: 'Skip build cache'
        required: false
        type: boolean
        default: false
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main, dev, feature/toga-migration ]

permissions:
  contents: read
  actions: write
  packages: read

env:
  PYTHON_VERSION: "3.12"
  FORCE_COLOR: "0"

concurrency:
  group: ${{ github.workflow}}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

defaults:
  run:
    shell: bash

jobs:
  setup:
    name: Setup and Versioning
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Extract version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version_override }}" ]; then
            VERSION="${{ github.event.inputs.version_override }}"
            VERSION=${VERSION#v}
          else
            VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

  build:
    name: Build ${{ matrix.platform }}
    needs: setup
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            artifact_prefix: windows-
            installer_pattern: "*.msi"
          - platform: macOS
            os: macos-latest
            artifact_prefix: macos-
            installer_pattern: "*.dmg"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/Library/Caches/pip
            ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-build-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-build-pip-

      - name: Cache Briefcase build cache
        uses: actions/cache@v4
        if: ${{ !github.event.inputs.skip_cache }}
        with:
          path: |
            build/
            dist/
            logs/
          key: ${{ runner.os }}-briefcase-${{ hashFiles('src/**/*.py', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-briefcase-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e .
          pip install briefcase

      - name: Update version in pyproject.toml
        run: |
          VERSION="${{ needs.setup.outputs.version }}"
          python - << 'PY'
          from pathlib import Path
          import re

          VERSION = "${{ needs.setup.outputs.version }}"
          py = Path("pyproject.toml")
          text = py.read_text("utf-8")

          # Replace project.version
          text = re.sub(r'version = "[^"]*"', f'version = "{VERSION}"', text, count=1)

          # Replace tool.briefcase.version (using lambda to avoid backref issues)
          text = re.sub(
              r'(\[tool\.briefcase\][\s\S]*?version = ")[^"]*(")',
              lambda m: f"{m.group(1)}{VERSION}{m.group(2)}",
              text,
              count=1,
          )

          py.write_text(text, encoding="utf-8")
          PY
          echo "Updated version to: $VERSION"

      - name: Create Briefcase app scaffold
        run: |
          echo "Creating Briefcase app scaffold..."
          python installer/make.py create --platform ${{ matrix.platform }}
        env:
          DISPLAY: ""
          ACCESSIWEATHER_TEST_MODE: "1"
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "utf-8"

      - name: Build Briefcase app
        run: |
          echo "Building Briefcase app..."
          python installer/make.py build --platform ${{ matrix.platform }}
        env:
          DISPLAY: ""
          ACCESSIWEATHER_TEST_MODE: "1"
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "utf-8"

      - name: Create portable ZIP
        run: |
          echo "Creating portable ZIP..."
          python installer/make.py zip --platform ${{ matrix.platform }} || true
        env:
          DISPLAY: ""
          ACCESSIWEATHER_TEST_MODE: "1"
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "utf-8"

      - name: Package Briefcase app
        run: |
          echo "Packaging Briefcase app..."
          python installer/make.py package --platform ${{ matrix.platform }}
        env:
          DISPLAY: ""
          ACCESSIWEATHER_TEST_MODE: "1"
          PYTHONUTF8: "1"
          PYTHONIOENCODING: "utf-8"

      - name: Verify outputs and generate checksums
        run: |
          VERSION="${{ needs.setup.outputs.version }}"
          PLATFORM="${{ matrix.platform }}"
          echo "Verifying build outputs for version: $VERSION"

          # Find artifacts
          INSTALLER=$(find dist -name "${{ matrix.installer_pattern }}" | head -1)
          ZIP_FILE=$(find dist -name "*Portable_v$VERSION.zip" -o -name "*macOS_v$VERSION.zip" | head -1)

          CHECKSUM_FILE="dist/${PLATFORM}-checksums.txt"
          echo "AccessiWeather $PLATFORM v$VERSION - Build Checksums" > "$CHECKSUM_FILE"
          echo "" >> "$CHECKSUM_FILE"

          # Helper python script for hashing
          cat > hash_helper.py << 'EOF'
          import hashlib, sys, pathlib
          p = pathlib.Path(sys.argv[1])
          if p.exists():
              h = hashlib.sha256(p.read_bytes()).hexdigest()
              s = p.stat().st_size / (1024*1024)
              print(f"{h}  {p.name}")
              print(f"INFO: {p.name} ({s:.2f} MB)")
          EOF

          BUILD_SUCCESS=true

          if [ -n "$INSTALLER" ] && [ -f "$INSTALLER" ]; then
              OUTPUT=$(python hash_helper.py "$INSTALLER")
              echo "$OUTPUT" | grep -v "INFO" >> "$CHECKSUM_FILE"
              echo "✓ Installer: $(echo "$OUTPUT" | grep "INFO" | cut -d: -f2-)"
          else
              echo "✗ Missing Installer"
              BUILD_SUCCESS=false
          fi

          if [ -n "$ZIP_FILE" ] && [ -f "$ZIP_FILE" ]; then
              OUTPUT=$(python hash_helper.py "$ZIP_FILE")
              echo "$OUTPUT" | grep -v "INFO" >> "$CHECKSUM_FILE"
              echo "✓ ZIP: $(echo "$OUTPUT" | grep "INFO" | cut -d: -f2-)"
          else
               # Zip is optional-ish on macOS but mandatory on Windows in original script
               if [ "$PLATFORM" == "windows" ]; then
                   echo "✗ Missing ZIP"
                   BUILD_SUCCESS=false
               else
                   echo "⚠ Missing ZIP (Optional)"
               fi
          fi

          if [ "$BUILD_SUCCESS" != "true" ]; then
              echo "Build verification failed"
              exit 1
          fi

          echo "✓ Checksums saved to $CHECKSUM_FILE"

      - name: Upload artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.artifact_prefix }}${{ needs.setup.outputs.version }}
          path: |
            dist/${{ matrix.installer_pattern }}
            dist/*.zip
            dist/*checksums.txt
          retention-days: 30

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: logs-${{ matrix.platform }}
          path: logs/*

  validate:
    name: Validate Build
    runs-on: windows-latest
    needs: [setup, build]
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v6
        with:
          name: windows-${{ needs.setup.outputs.version }}
          path: artifacts/windows/

      - name: Validate build artifacts
        run: |
          VERSION="${{ needs.setup.outputs.version }}"
          echo "=== Build Validation ==="

          MSI_FILE=$(find artifacts/windows -name "*.msi" | head -1)
          PORTABLE_FILE=$(find artifacts/windows -name "*Portable*.zip" | head -1)

          ALL_OK=true

          if [ -n "$MSI_FILE" ]; then
             echo "✓ MSI found: $(basename "$MSI_FILE")"
          else
             echo "✗ MSI missing"
             ALL_OK=false
          fi

          if [ -n "$PORTABLE_FILE" ]; then
             echo "✓ Portable ZIP found: $(basename "$PORTABLE_FILE")"
          else
             echo "✗ Portable ZIP missing"
             ALL_OK=false
          fi

          if [ "$ALL_OK" != "true" ]; then
             exit 1
          fi
