name: Build and Package with Briefcase

on:
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Override version (optional)'
        required: false
        type: string
      skip_cache:
        description: 'Skip build cache'
        required: false
        type: boolean
        default: false
      force_rebuild:
        description: 'Force rebuild even if release exists'
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (e.g., v0.4.2)
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main, dev, feature/toga-migration ]  # Trigger after CI on main, dev and toga-migration branches

permissions:
  contents: read      # Read repository contents
  actions: write      # Trigger repository dispatch events
  packages: read      # Read packages (for caching)

env:
  # Build configuration
  PYTHON_VERSION: "3.12"
  FORCE_COLOR: "0"
  PYTHONUTF8: "1"

# Cancel active builds for a PR before starting another run
concurrency:
  group: ${{ github.workflow}}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

defaults:
  run:
    shell: bash

jobs:
  check-release:
    name: Check if release already exists
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check if release exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          TAG="v${VERSION}"

          echo "Checking for existing release: ${TAG}"

          # Force rebuild if requested via input
          if [ "${{ github.event.inputs.force_rebuild }}" == "true" ]; then
            echo "Force rebuild requested. Proceeding with build."
            echo "should_build=true" >> $GITHUB_OUTPUT
          # Only skip build if release exists AND has artifacts AND not a manual trigger
          elif gh release view "${TAG}" &>/dev/null; then
            # Check if release has binaries/assets (not just checksums)
            ASSET_COUNT=$(gh api repos/${{ github.repository }}/releases/tags/${TAG} --jq '.assets | map(select(.name != "checksums.txt")) | length')
            if [ "$ASSET_COUNT" -gt 0 ]; then
              echo "Release ${TAG} already exists with assets. Skipping build."
              echo "should_build=false" >> $GITHUB_OUTPUT
            else
              echo "Release ${TAG} exists but missing assets. Proceeding with rebuild."
              echo "should_build=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "Release ${TAG} does not exist. Proceeding with build."
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build ${{ matrix.platform }} Application
    runs-on: ${{ matrix.os }}
    needs: check-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            installer_pattern: "*.msi"
          - os: macos-latest
            platform: macOS
            installer_pattern: "*.dmg"

    if: ${{ (github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')) && needs.check-release.outputs.should_build == 'true' }}

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Fetch full history for build metadata

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v5
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-build-pip-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-pip-

    - name: Cache Briefcase build cache
      uses: actions/cache@v5
      if: ${{ !github.event.inputs.skip_cache }}
      with:
        path: |
          build/
          dist/
          logs/
        key: ${{ runner.os }}-briefcase-${{ hashFiles('src/**/*.py', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-briefcase-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -e .[dev]
        pip install briefcase

    - name: Extract version
      id: version
      shell: bash
      run: |
        if [ -n "${{ github.event.inputs.version_override }}" ]; then
          VERSION="${{ github.event.inputs.version_override }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
        else
          VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Update version in pyproject.toml
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Update project version using sed (more reliable in CI)
        # Mac sed requires a backup extension (even if empty string)
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/version = \"[^\"]*\"/version = \"$VERSION\"/" pyproject.toml
            sed -i '' "/\[tool\.briefcase\]/,/\[/ s/version = \"[^\"]*\"/version = \"$VERSION\"/" pyproject.toml
        else
            sed -i "s/version = \"[^\"]*\"/version = \"$VERSION\"/" pyproject.toml
            sed -i "/\[tool\.briefcase\]/,/\[/ s/version = \"[^\"]*\"/version = \"$VERSION\"/" pyproject.toml
        fi

        echo "Updated version to: $VERSION"

    - name: Create Briefcase app scaffold
      run: |
        echo "Creating Briefcase app scaffold..."
        python installer/make.py create --platform ${{ matrix.platform }}
      env:
        DISPLAY: ""
        ACCESSIWEATHER_TEST_MODE: "1"

    - name: Build Briefcase app
      run: |
        echo "Building Briefcase app..."
        python installer/make.py build --platform ${{ matrix.platform }}
      env:
        DISPLAY: ""
        ACCESSIWEATHER_TEST_MODE: "1"

    - name: Create portable ZIP version (Windows only)
      if: matrix.platform == 'windows'
      run: |
        echo "Creating portable ZIP version..."
        python installer/make.py zip --platform windows || true
      env:
        DISPLAY: ""
        ACCESSIWEATHER_TEST_MODE: "1"

    - name: Package Briefcase app
      run: |
        echo "Packaging Briefcase app..."
        python installer/make.py package --platform ${{ matrix.platform }}
      env:
        DISPLAY: ""
        ACCESSIWEATHER_TEST_MODE: "1"


    - name: Verify build outputs and generate checksums
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        echo "Verifying build outputs for version: $VERSION"

        # Check for installer
        INSTALLER_PATH=$(find dist -name "${{ matrix.installer_pattern }}" | head -1)

        if [ "${{ matrix.platform }}" == "windows" ]; then
            ZIP_PATH="dist/AccessiWeather_Portable_v$VERSION.zip"
        fi

        BUILD_SUCCESS=true

        # Verify Installer
        if [ -n "$INSTALLER_PATH" ] && [ -f "$INSTALLER_PATH" ]; then
          # Use generic stat for size if powershell not available (macOS/Linux)
          if command -v powershell >/dev/null; then
              FILE_SIZE_MB=$(powershell -Command "('{0:N2}' -f ((Get-Item '$INSTALLER_PATH').Length / 1MB))")
              # SHA256 calculation
              FILE_HASH=$(powershell -Command "(Get-FileHash '$INSTALLER_PATH' -Algorithm SHA256).Hash")
          else
              FILE_SIZE_MB=$(du -m "$INSTALLER_PATH" | cut -f1)
              if command -v sha256sum >/dev/null; then
                  FILE_HASH=$(sha256sum "$INSTALLER_PATH" | cut -d' ' -f1)
              else
                  FILE_HASH=$(shasum -a 256 "$INSTALLER_PATH" | cut -d' ' -f1)
              fi
          fi

          echo "✓ Installer: $INSTALLER_PATH ($FILE_SIZE_MB MB)"
          echo "  SHA256: ${FILE_HASH:0:16}..."
        else
          echo "✗ Missing Installer: ${{ matrix.installer_pattern }}"
          echo "Contents of dist directory:"
          find dist -type f | head -10
          BUILD_SUCCESS=false
        fi

        # Verify portable ZIP (Windows only)
        if [ "${{ matrix.platform }}" == "windows" ]; then
            if [ -f "$ZIP_PATH" ]; then
              FILE_SIZE_MB=$(powershell -Command "('{0:N2}' -f ((Get-Item '$ZIP_PATH').Length / 1MB))")
              ZIP_HASH=$(powershell -Command "(Get-FileHash '$ZIP_PATH' -Algorithm SHA256).Hash")
              echo "✓ Portable ZIP: $ZIP_PATH ($FILE_SIZE_MB MB)"
              echo "  SHA256: ${ZIP_HASH:0:16}..."
            else
              echo "✗ Missing portable ZIP: $ZIP_PATH"
              BUILD_SUCCESS=false
            fi
        fi

        if [ "$BUILD_SUCCESS" != "true" ]; then
          echo "Build verification failed - missing required files"
          exit 1
        fi

        # Generate checksums file
        echo "AccessiWeather v$VERSION - ${{ matrix.platform }} Build Checksums" > dist/checksums.txt
        echo "" >> dist/checksums.txt
        if [ -n "$INSTALLER_PATH" ]; then
          echo "$FILE_HASH  $(basename "$INSTALLER_PATH")" >> dist/checksums.txt
        fi
        if [ "${{ matrix.platform }}" == "windows" ] && [ -n "$ZIP_HASH" ]; then
          echo "$ZIP_HASH  AccessiWeather_Portable_v$VERSION.zip" >> dist/checksums.txt
        fi
        echo "✓ Checksums saved to dist/checksums.txt"

    - name: Upload portable build artifact (Windows only)
      if: matrix.platform == 'windows'
      uses: actions/upload-artifact@v6
      with:
        name: windows-portable-${{ steps.version.outputs.version }}
        path: |
          dist/AccessiWeather_Portable_v${{ steps.version.outputs.version }}.zip
          dist/checksums.txt
        retention-days: 30

    - name: Upload Installer artifact
      uses: actions/upload-artifact@v6
      with:
        name: ${{ matrix.platform }}-installer-${{ steps.version.outputs.version }}
        path: |
          dist/${{ matrix.installer_pattern }}
          dist/checksums.txt
        retention-days: 90

    - name: Upload Briefcase logs on failure
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: briefcase-build-logs-${{ matrix.platform }}
        path: logs/*

  validate:
    name: Validate Build
    runs-on: windows-latest
    needs: [check-release, build]
    if: ${{ needs.check-release.outputs.should_build == 'true' }}

    steps:
    - name: Download installer artifacts
      uses: actions/download-artifact@v7
      with:
        name: windows-installer-${{ needs.build.outputs.version }}
        path: artifacts/installer/

    - name: Download portable artifacts
      uses: actions/download-artifact@v7
      with:
        name: windows-portable-${{ needs.build.outputs.version }}
        path: artifacts/portable/

    - name: Validate build artifacts
      run: |
        VERSION="${{ needs.build.outputs.version }}"

        echo "=== Build Validation ==="
        echo "Version: $VERSION"

        # Check installer artifacts
        MSI_FILE=$(find artifacts/installer -name "*.msi" | head -1)

        # Check portable artifacts
        PORTABLE_FILE="artifacts/portable/AccessiWeather_Portable_v$VERSION.zip"
        PORTABLE_CHECKSUMS="artifacts/portable/checksums.txt"

        ALL_FILES_PRESENT=true

        echo "Checking installer artifacts:"
        if [ -n "$MSI_FILE" ] && [ -f "$MSI_FILE" ]; then
          FILE_SIZE=$(powershell -Command "(Get-Item '$MSI_FILE').Length")
          FILE_SIZE_MB=$(powershell -Command "('{0:N2}' -f ((Get-Item '$MSI_FILE').Length / 1MB))")
          echo "✓ $(basename "$MSI_FILE") ($FILE_SIZE_MB MB)"
        else
          echo "✗ Missing: MSI installer"
          ALL_FILES_PRESENT=false
        fi

        echo "Checking portable artifacts:"
        if [ -f "$PORTABLE_FILE" ]; then
          FILE_SIZE=$(powershell -Command "(Get-Item '$PORTABLE_FILE').Length")
          FILE_SIZE_MB=$(powershell -Command "('{0:N2}' -f ((Get-Item '$PORTABLE_FILE').Length / 1MB))")
          echo "✓ AccessiWeather_Portable_v$VERSION.zip ($FILE_SIZE_MB MB)"
        else
          echo "✗ Missing: AccessiWeather_Portable_v$VERSION.zip"
          ALL_FILES_PRESENT=false
        fi

        if [ "$ALL_FILES_PRESENT" = "true" ]; then
          echo "✅ Build validation successful - separate artifacts created"
        else
          echo "❌ Build validation failed"
          exit 1
        fi
