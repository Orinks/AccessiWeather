name: Update GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build-pages:
    name: Build Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
      - name: Build pages content
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python <<'PY'
          from __future__ import annotations

          import datetime as dt
          import html
          import json
          import os
          import urllib.request

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ.get("GITHUB_TOKEN", "")
          releases_url = f"https://github.com/{repo}/releases"

          def request_json(url: str) -> list[dict]:
              headers = {
                  "Accept": "application/vnd.github+json",
                  "Authorization": f"Bearer {token}",
                  "X-GitHub-Api-Version": "2022-11-28",
              }
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req) as resp:
                  return json.loads(resp.read().decode("utf-8"))

          def render_markdown(text: str) -> str:
              """Convert markdown to HTML using GitHub's Markdown API."""
              if not text.strip():
                  return ""
              headers = {
                  "Accept": "application/vnd.github+json",
                  "Authorization": f"Bearer {token}",
                  "X-GitHub-Api-Version": "2022-11-28",
                  "Content-Type": "application/json",
              }
              data = json.dumps({
                  "text": text,
                  "mode": "gfm",
                  "context": repo,
              }).encode("utf-8")
              req = urllib.request.Request(
                  "https://api.github.com/markdown",
                  data=data,
                  headers=headers,
                  method="POST",
              )
              try:
                  with urllib.request.urlopen(req) as resp:
                      return resp.read().decode("utf-8")
              except Exception:
                  # Fallback to escaped text in pre block
                  return f"<pre>{html.escape(text)}</pre>"

          def latest_release(releases: list[dict], is_prerelease: bool) -> dict | None:
              for rel in releases:
                  if rel.get("draft"):
                      continue
                  if rel.get("prerelease", False) == is_prerelease:
                      return rel
              return None

          def format_date(date_str: str | None) -> str:
              if not date_str:
                  return "N/A"
              try:
                  dt_obj = dt.datetime.fromisoformat(date_str.replace("Z", "+00:00"))
                  return dt_obj.strftime("%Y-%m-%d %H:%M UTC")
              except Exception:
                  return date_str

          releases = request_json(
              f"https://api.github.com/repos/{repo}/releases?per_page=100"
          )
          stable = latest_release(releases, False)
          prerelease = latest_release(releases, True)

          def get_asset_urls(release: dict | None) -> dict[str, str]:
              """Extract asset download URLs from a release."""
              result = {
                  "installer": releases_url,
                  "portable": releases_url,
                  "macos": releases_url,
              }
              if not release:
                  return result
              assets = release.get("assets", [])
              release_url = release.get("html_url", releases_url)
              for asset in assets:
                  name = asset.get("name", "").lower()
                  url = asset.get("browser_download_url", release_url)
                  if name.endswith(".msi"):
                      result["installer"] = url
                  elif "setup" in name and name.endswith(".exe"):
                      result["installer"] = url
                  elif "portable" in name and name.endswith(".zip"):
                      result["portable"] = url
                  elif name.endswith(".dmg"):
                      result["macos"] = url
              return result

          main_version = (stable or {}).get("tag_name", "Latest Release").lstrip("v")
          main_date = format_date((stable or {}).get("published_at"))
          main_commit = (stable or {}).get("target_commitish", "")
          main_has_release = "true" if stable else "false"
          main_assets = get_asset_urls(stable)
          main_notes_raw = (stable or {}).get("body", "")
          if main_notes_raw:
              main_notes = render_markdown(main_notes_raw)
          else:
              main_notes = f"<p>No stable release available. <a href=\"{releases_url}\">View releases</a></p>"

          dev_version = (prerelease or {}).get("tag_name", "Development").lstrip("v")
          dev_date = format_date((prerelease or {}).get("published_at"))
          dev_commit = (prerelease or {}).get("target_commitish", "")
          dev_release_url = (prerelease or {}).get("html_url", releases_url)
          dev_has_release = "true" if prerelease else "false"
          dev_assets = get_asset_urls(prerelease)
          dev_notes_raw = (prerelease or {}).get("body", "")
          if dev_notes_raw:
              dev_notes = render_markdown(dev_notes_raw)
          else:
              dev_notes = f"<p>No pre-release available. <a href=\"{releases_url}\">View releases</a></p>"

          last_updated = dt.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")

          substitutions = {
              "MAIN_VERSION": main_version,
              "MAIN_DATE": main_date,
              "MAIN_COMMIT": main_commit,
              "MAIN_INSTALLER_URL": main_assets["installer"],
              "MAIN_PORTABLE_URL": main_assets["portable"],
              "MAIN_MACOS_INSTALLER_URL": main_assets["macos"],
              "MAIN_HAS_RELEASE": main_has_release,
              "MAIN_RELEASE_NOTES": main_notes,
              "DEV_VERSION": dev_version,
              "DEV_DATE": dev_date,
              "DEV_COMMIT": dev_commit,
              "DEV_RELEASE_URL": dev_release_url,
              "DEV_INSTALLER_URL": dev_assets["installer"],
              "DEV_PORTABLE_URL": dev_assets["portable"],
              "DEV_MACOS_INSTALLER_URL": dev_assets["macos"],
              "DEV_HAS_RELEASE": dev_has_release,
              "DEV_RELEASE_NOTES": dev_notes,
              "LAST_UPDATED": last_updated,
          }

          with open("docs/index.template.html", "r", encoding="utf-8") as f:
              html_content = f.read()
          for key, value in substitutions.items():
              html_content = html_content.replace(f"{{{{{key}}}}}", value)
          with open("index.html", "w", encoding="utf-8") as f:
              f.write(html_content)

          with open("docs/download-links.md", "w", encoding="utf-8") as f:
              f.write(
                  "# AccessiWeather Download Links\n\n"
                  f"All downloads are on GitHub: {releases_url}\n\n"
                  "## Build Info\n\n"
                  f"- Main version: {main_version}\n"
                  f"- Main date: {main_date}\n"
                  f"- Dev version: {dev_version}\n"
                  f"- Dev date: {dev_date}\n"
                  f"- Last updated: {last_updated}\n"
              )

          with open(".nojekyll", "w", encoding="utf-8") as f:
              f.write("")
          PY
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./

  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
