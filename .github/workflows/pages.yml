name: Deploy GitHub Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: [ main, dev ]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  
  # Runs when build workflow completes successfully
  workflow_run:
    workflows: ["Build and Package"]
    types:
      - completed
    branches: [ main, dev ]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for build metadata

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Extract version from pyproject.toml
        id: version
        run: |
          python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
          version = data['project']['version']
          print(f'version={version}')
          " >> $GITHUB_OUTPUT

      - name: Get latest successful build artifacts info
        id: artifacts
        run: |
          # Get the latest successful workflow run for this branch
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Generate nightly.link URLs
          BASE_URL="https://nightly.link/Orinks/AccessiWeather/workflows/build"
          
          echo "installer_url=$BASE_URL/$BRANCH_NAME/windows-installer-${{ steps.version.outputs.version }}.zip" >> $GITHUB_OUTPUT
          echo "portable_url=$BASE_URL/$BRANCH_NAME/windows-build-${{ steps.version.outputs.version }}.zip" >> $GITHUB_OUTPUT
          
          # Also generate direct artifact download URLs
          echo "installer_direct_url=$BASE_URL/$BRANCH_NAME/windows-installer-${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
          echo "portable_direct_url=$BASE_URL/$BRANCH_NAME/windows-build-${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT

      - name: Create download page
        run: |
          mkdir -p _site
          
          # Get current date for build info
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          BRANCH_NAME="${{ steps.artifacts.outputs.branch }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # Determine if this is a stable or development build
          if [ "$BRANCH_NAME" = "main" ]; then
            BUILD_TYPE="Stable Release"
            BUILD_CLASS="stable"
            BUILD_DESCRIPTION="Latest stable release of AccessiWeather"
          else
            BUILD_TYPE="Development Build"
            BUILD_CLASS="dev"
            BUILD_DESCRIPTION="Latest development build from the $BRANCH_NAME branch"
          fi
          
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AccessiWeather Downloads</title>
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      line-height: 1.6;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .container {
                      background: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                  }
                  h1 {
                      color: #2c3e50;
                      text-align: center;
                      margin-bottom: 10px;
                  }
                  .subtitle {
                      text-align: center;
                      color: #7f8c8d;
                      margin-bottom: 30px;
                  }
                  .build-info {
                      background: #ecf0f1;
                      padding: 15px;
                      border-radius: 5px;
                      margin-bottom: 30px;
                  }
                  .build-info.stable {
                      background: #d5f4e6;
                      border-left: 4px solid #27ae60;
                  }
                  .build-info.dev {
                      background: #fff3cd;
                      border-left: 4px solid #f39c12;
                  }
                  .download-section {
                      margin: 30px 0;
                  }
                  .download-button {
                      display: inline-block;
                      background: #3498db;
                      color: white;
                      padding: 12px 24px;
                      text-decoration: none;
                      border-radius: 5px;
                      margin: 10px 10px 10px 0;
                      font-weight: bold;
                      transition: background-color 0.3s;
                  }
                  .download-button:hover {
                      background: #2980b9;
                  }
                  .download-button.primary {
                      background: #27ae60;
                  }
                  .download-button.primary:hover {
                      background: #229954;
                  }
                  .info-box {
                      background: #e8f4fd;
                      border: 1px solid #bee5eb;
                      border-radius: 5px;
                      padding: 15px;
                      margin: 20px 0;
                  }
                  .footer {
                      text-align: center;
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 1px solid #ecf0f1;
                      color: #7f8c8d;
                  }
                  .version-badge {
                      background: #34495e;
                      color: white;
                      padding: 4px 8px;
                      border-radius: 3px;
                      font-size: 0.9em;
                      font-weight: bold;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üå§Ô∏è AccessiWeather Downloads</h1>
                  <p class="subtitle">Accessible Weather Information for Everyone</p>
                  
                  <div class="build-info BUILD_CLASS">
                      <h3>BUILD_TYPE <span class="version-badge">v VERSION</span></h3>
                      <p>BUILD_DESCRIPTION</p>
                      <p><strong>Built:</strong> BUILD_DATE | <strong>Branch:</strong> BRANCH_NAME</p>
                  </div>
          
                  <div class="download-section">
                      <h2>üì• Download Options</h2>
                      
                      <h3>üîß Windows Installer (Recommended)</h3>
                      <p>Full installation package with automatic updates and system integration.</p>
                      <a href="INSTALLER_URL" class="download-button primary">Download Installer</a>
                      <a href="INSTALLER_DIRECT_URL" class="download-button">View Files</a>
                      
                      <h3>üì¶ Portable Version</h3>
                      <p>Standalone executable that doesn't require installation. Perfect for USB drives or temporary use.</p>
                      <a href="PORTABLE_URL" class="download-button">Download Portable</a>
                      <a href="PORTABLE_DIRECT_URL" class="download-button">View Files</a>
                  </div>
          
                  <div class="info-box">
                      <h3>‚ÑπÔ∏è About These Downloads</h3>
                      <ul>
                          <li><strong>Automatic Updates:</strong> Downloads are automatically generated from the latest code</li>
                          <li><strong>Security:</strong> All builds are created using GitHub Actions with verified source code</li>
                          <li><strong>Compatibility:</strong> Supports Windows 10 and Windows 11</li>
                          <li><strong>No Login Required:</strong> Direct downloads powered by nightly.link</li>
                      </ul>
                  </div>
          
                  <div class="download-section">
                      <h2>üîó Alternative Download Methods</h2>
                      <p>You can also download builds from:</p>
                      <ul>
                          <li><a href="https://github.com/Orinks/AccessiWeather/releases">GitHub Releases</a> - Official tagged releases</li>
                          <li><a href="https://github.com/Orinks/AccessiWeather/actions">GitHub Actions</a> - All build artifacts (requires GitHub login)</li>
                      </ul>
                  </div>
          
                  <div class="footer">
                      <p>
                          <a href="https://github.com/Orinks/AccessiWeather">üîó View Source Code</a> |
                          <a href="https://github.com/Orinks/AccessiWeather/issues">üêõ Report Issues</a> |
                          <a href="https://github.com/Orinks/AccessiWeather/blob/main/docs/user_manual.md">üìñ User Manual</a>
                      </p>
                      <p>AccessiWeather is open source software. Built with ‚ù§Ô∏è for accessibility.</p>
                  </div>
              </div>
          </body>
          </html>
          EOF
          
          # Replace placeholders with actual values
          sed -i "s/VERSION/$VERSION/g" _site/index.html
          sed -i "s/BUILD_DATE/$BUILD_DATE/g" _site/index.html
          sed -i "s/BRANCH_NAME/$BRANCH_NAME/g" _site/index.html
          sed -i "s/BUILD_TYPE/$BUILD_TYPE/g" _site/index.html
          sed -i "s/BUILD_CLASS/$BUILD_CLASS/g" _site/index.html
          sed -i "s|BUILD_DESCRIPTION|$BUILD_DESCRIPTION|g" _site/index.html
          sed -i "s|INSTALLER_URL|${{ steps.artifacts.outputs.installer_url }}|g" _site/index.html
          sed -i "s|PORTABLE_URL|${{ steps.artifacts.outputs.portable_url }}|g" _site/index.html
          sed -i "s|INSTALLER_DIRECT_URL|${{ steps.artifacts.outputs.installer_direct_url }}|g" _site/index.html
          sed -i "s|PORTABLE_DIRECT_URL|${{ steps.artifacts.outputs.portable_direct_url }}|g" _site/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
